<head>
  <link href="../static/css/c3.min.css" rel="stylesheet">
  <link href="../static/css/bootstrap.min.css" rel="stylesheet">
  <script type="text/javascript" src="../static/js/jquery.min.js"></script>
  <script type="text/javascript" src="../static/js/d3.min.js"></script>
  <script type="text/javascript" src="../static/js/c3.min.js"></script>
</head>

<body>
  <div class="container">
    <h1>Keras - Total Visualization Project</h1>


    <hr>
    <h2>Accurancy</h2>
    <div id="accChart"></div>
    <h2>Loss</h2>
    <div id="lossChart"></div>
    <h2>Other</h2>
    <div id="otherChart"></div>
  </div>

</body>

<script type="text/javascript">
  var createCharts = function(){
    accChart = c3.generate({
      bindto:'#accChart',
      data: {
        x: 'epoch',
        columns: []
      }
    });
    lossChart = c3.generate({
      bindto:'#lossChart',
      data: {
        x: 'epoch',
        columns: []
      }
    });
    otherChart = c3.generate({
      bindto:'#otherChart',
      data: {
        x: 'epoch',
        columns: []
      }
    });
  };
  var monitored = {};
  var accChart = null;
  var lossChart = null;
  var otherChart = null;
  var updateChart = function(chart, allColumns, fields){
    chartColumns = []
    chartColumns.push(allColumns["epoch"]);
    for(key in allColumns){
      for(var i in fields){
        field = fields[i];
        if(key==field){
          chartColumns.push(allColumns[key]);
        }
      }
    }
    chart.load({
      columns:chartColumns
    });
  };

  var update = function(data) {
    for (key in data) {
      if (key in monitored) {
        monitored[key].push(data[key]);
      } else {
        monitored[key] = [key, data[key]];
      }
    }
    updateChart(accChart,monitored,["acc", "val_acc"]);
    updateChart(lossChart,monitored,["loss", "val_loss"]);
    updateChart(otherChart,monitored,["batch", "size"]);
  };

  var addTestData = function() {
    mydata1 = {
      "acc":0.953,
      "loss":0.185,
      "batch":92,
      "epoch":20,
      "val_acc":0.94,
      "val_loss":0.11,
      "size":127
    };
    mydata2 = {
      "acc":0.97,
      "loss":0.17,
      "batch":92,
      "epoch":21,
      "val_acc":0.96,
      "val_loss":0.10,
      "size":127
    };
    update(mydata1);
    update(mydata2);
  };

  $(document).ready(function(){

    var source = new EventSource('/subscribe/epoch/end/');
    createCharts();
    //addTestData();
    source.addEventListener('message', function(e) {
      console.log(e.data);
      var data = JSON.parse(e.data);
      console.log(data);
      update(data);

    }, false);
  });

</script>
