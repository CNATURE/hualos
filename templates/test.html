<head>
  <link href="../static/css/c3.min.css" rel="stylesheet">
  <link href="../static/css/bootstrap.min.css" rel="stylesheet">
  <script type="text/javascript" src="../static/js/jquery.min.js"></script>
  <script type="text/javascript" src="../static/js/d3.min.js"></script>
  <script type="text/javascript" src="../static/js/c3.min.js"></script>
</head>

<body>
  <div class="container">
    <h1>Keras - Total Visualization Project</h1>
    <hr>
    <h2>Accurancy</h2>
    <div id="accChart"></div>
    <h2>Loss</h2>
    <div id="lossChart"></div>
    <h2>Other</h2>
    <div id="otherChart"></div>
  </div>

</body>

<script type="text/javascript">
  var C3Chart = function(divId,fields){
    var these = this;
    these.divId = divId;
    these.fields = fields;
    these.chart = null;
    var monitored = {};

    these.init = function(){
      console.log("init " + these.divId);
      these.chart = c3.generate({
        bindto:'#' + these.divId,
        data: {
          x: 'epoch',
          columns: []
        }
      });
    };
    these.update = function(newData){
      fillToMonitored(newData);
      updateChart();
    };
    var fillToMonitored = function(newData){
      for (key in newData) {
        if (key in monitored) {
          monitored[key].push(newData[key]);
        } else {
          monitored[key] = [key, newData[key]];
        }
      }
    };
    var updateChart = function(){
      chartColumns = []
      chartColumns.push(monitored["epoch"]);
      for(key in monitored){
        for(var i in these.fields){
          field = these.fields[i];
          if(key==field){
            chartColumns.push(monitored[key]);
          }
        }
      }
      these.chart.load({
        columns:chartColumns
      });
    };
  };

  accChart = new C3Chart("accChart",["acc", "val_acc"]);
  lossChart = new C3Chart("lossChart",["loss", "val_loss"]);
  otherChart = new C3Chart("otherChart",["batch", "size"]);

  var update = function(newData){
    accChart.update(newData);
    lossChart.update(newData);
    otherChart.update(newData);
  };
  var addTestData = function() {
    mydata1 = {
      "acc":0.953,
      "loss":0.185,
      "batch":92,
      "epoch":20,
      "val_acc":0.94,
      "val_loss":0.11,
      "size":127
    };
    mydata2 = {
      "acc":0.97,
      "loss":0.17,
      "batch":92,
      "epoch":21,
      "val_acc":0.96,
      "val_loss":0.10,
      "size":127
    };
    update(mydata1);
    update(mydata2);
  };

  $(document).ready(function(){
    accChart.init();
    lossChart.init();
    otherChart.init();

    var source = new EventSource('/subscribe/epoch/end/');

    addTestData();
    source.addEventListener('message', function(e) {
      console.log(e.data);
      var data = JSON.parse(e.data);
      console.log(data);
      update(data);

    }, false);
  });

</script>
